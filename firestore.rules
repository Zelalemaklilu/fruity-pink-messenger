rules_version = '2';

service cloud.firestore {

  match /databases/{database}/documents {

    // =========================
    // ACCOUNTS
    // =========================
    match /accounts/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // =========================
    // CHATS (STRICT)
    // =========================
    match /chats/{chatId} {
      // Create chat: exactly 2 participants, creator must be one of them
      allow create: if request.auth != null
        && request.resource.data.participants.size() == 2
        && request.auth.uid in request.resource.data.participants;

      // Read / update / delete chat: only participants
      allow read, update, delete: if request.auth != null
        && request.auth.uid in resource.data.participants;

      // =========================
      // MESSAGES (ULTRA-STRICT)
      // =========================
      match /messages/{messageId} {
        // Create message: sender must be auth user + must be chat participant
        allow create: if request.auth != null
          && request.resource.data.senderId == request.auth.uid
          && request.auth.uid in
             get(/databases/$(database)/documents/chats/$(chatId))
               .data.participants;

        // Read messages: only chat participants
        allow read: if request.auth != null
          && request.auth.uid in
             get(/databases/$(database)/documents/chats/$(chatId))
               .data.participants;

        // Update message (READ-RECEIPT ONLY â€” CONTENT IMMUTABLE)
        allow update: if request.auth != null
          && request.auth.uid in
             get(/databases/$(database)/documents/chats/$(chatId))
               .data.participants
          // ===== ABSOLUTE IMMUTABILITY =====
          && request.resource.data.senderId   == resource.data.senderId
          && request.resource.data.text       == resource.data.text
          && request.resource.data.type       == resource.data.type
          && request.resource.data.mediaUrl   == resource.data.mediaUrl
          && request.resource.data.fileName   == resource.data.fileName
          && request.resource.data.createdAt  == resource.data.createdAt;
      }
    }

  }

}
