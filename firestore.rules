rules_version = '2';

service cloud.firestore {

  match /databases/{database}/documents {

    // =========================
    // ACCOUNTS
    // =========================
    match /accounts/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // =========================
    // CHATS (STRICT)
    // =========================
    match /chats/{chatId} {
      // Create chat: exactly 2 participants, creator must be one of them
      allow create: if request.auth != null
        && request.resource.data.participants.size() == 2
        && request.auth.uid in request.resource.data.participants;

      // Read / update / delete chat: only participants
      allow read, update, delete: if request.auth != null
        && request.auth.uid in resource.data.participants;

      // =========================
      // MESSAGES
      // =========================
      match /messages/{messageId} {
        // Create message: sender must be auth user + must be chat participant
        allow create: if request.auth != null
          && request.resource.data.senderId == request.auth.uid
          && request.auth.uid in
             get(/databases/$(database)/documents/chats/$(chatId))
               .data.participants;

        // Read messages: only chat participants
        allow read: if request.auth != null
          && request.auth.uid in
             get(/databases/$(database)/documents/chats/$(chatId))
               .data.participants;

        // Update message: RECEIVER can update status field ONLY
        allow update: if request.auth != null
          && request.auth.uid == resource.data.receiverId
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])
          && request.resource.data.status in ['delivered', 'read'];
      }
    }

  }

}
